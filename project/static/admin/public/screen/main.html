<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>首页统计图</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts-wordcloud/2.1.0/echarts-wordcloud.min.js"></script>
    <script>
        if (typeof echarts === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"><\/script>');
        }
    </script>
    <link rel="stylesheet" href="./css/main.css">
    <script src="./base.js"></script>
</head>
<body>
    <div class="container">
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const user_id = urlParams.get("user_id"); // 获取 user_id 的值
        const user_group = urlParams.get("user_group"); // 获取 user_group 的值

        if (!user_id || !user_group){
            throw new Error("中断执行");
        }

        var permissions;

        async function get_list() {
            await fetch(baseUrl + '/api/auth/get_list?user_group='+user_group)
                    .then(res => res.json())
                    .then(data => {
                        if (data.result && data.result.list) {
                            permissions = data.result.list
                        }
                    })
                    .catch(err => {
                        console.error('加载权限数据失败:', err);
                    });
        }

        async function checkPermissionsAndShowCharts() {
            await get_list();

            function $get_power(path) {
                if (!permissions){
                    return null;
                }
                let list = permissions;
                let obj;
                for (var i = 0; i < list.length; i++) {
                    var o = list[i];
                    if (o.path === path) {
                        obj = o;
                        break;
                    }
                }
                return obj;
            }

            /**
             * 是否有统计字段的权限
             */
            function $check_figure(path) {
                let o = $get_power(path);
                if (o) {
                    let option = JSON.parse(o.option);
                    if (option.figure)
                        return true
                }
                return false;
            }

            //权限验证
            resizeChart();
        }

        // 执行权限检查和图表显示
        checkPermissionsAndShowCharts();

        // 用户列表缓存
        let userListCache = [];

        // 获取用户列表并缓存
        async function fetchAndCacheUserList() {
            await fetch(baseUrl + '/api/user/get_list')
                .then(res => res.json())
                .then(data => {
                    if (data.result && data.result.list) {
                        userListCache = data.result.list;
                    }
                })
                .catch(err => {
                    console.error('获取用户列表失败:', err);
                });
        }

        fetchAndCacheUserList();

        // 通过 user_id 获取 nickname
        function getNicknameByUserId(userId) {
            const user = userListCache.find(u => u.user_id === userId);
            return user ? user.nickname : '未知用户';
        }

        // 获取地址
        function fullUrl(url) {
            var url_new = "";
            if (url) {
                if (url.indexOf("~/") === 0) {
                    url_new = url.replace('~/', baseUrl+'/');
                } else if (url.indexOf("/http://") === 0) {
                    url_new = url.replace('/http://', 'http://');
                } else if (url.indexOf("/") === 0) {
                    url_new = url.replace('/', baseUrl+'/');
                } else if (url.indexOf("~") === 0) {
                    url_new = url.replace('~', '');
                } else {
                    url_new = url;
                }
            }
            return url_new;
        }

        // 处理时间
        function toTime(time, format) {
            let ret = "";
            if(time){
                let is_date = time instanceof Date;
                let is_num = typeof(time) == 'number';
                if(is_date){
                    ret = time.toStr(format);
                }
                else if(is_num){
                    let t = new Date(time);
                    ret = t.toStr(format);
                }
                else {
                    let reg = /^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/;
                    let regExp = new RegExp(reg);
                    if(regExp.test(time)){
                        ret = time;
                    }else {
                        ret = toDateStr(new Date(time.replace('T', ' ').replace('Z', '').replaceAll('-', '/')),format);
                    }
                }
            }
            return ret;
        }

        function toDateStr(time,format) {
            let o = {
                "M+": time.getMonth() + 1,
                "d+": time.getDate(),
                "h+": time.getHours(),
                "m+": time.getMinutes(),
                "s+": time.getSeconds(),
                "q+": Math.floor((time.getMonth() + 3) / 3),
                "S": time.getMilliseconds()
            };
            if (/(y+)/.test(format)) {
                let x = RegExp.$1;
                format = format.replace(x, (time.getFullYear() + "").substr(4 - x.length));
            }
            for (let k in o) {
                if (new RegExp("(" + k + ")").test(format)) {
                    let x = RegExp.$1;
                    format = format.replace(x, x.length === 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
                }
            }
            return format;
        }


        function resizeChart() {
        }

        // 窗口大小改变时，重置图表大小
        window.addEventListener('resize', resizeChart);
    </script>
</body>
</html>
